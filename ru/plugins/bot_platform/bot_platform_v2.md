# **Bot Platform 2.0**

  

# Content



- [Что такое Bot Platform](#что-такое-bot-platform)

- [Архитектура](#архитектура)

- [Как создать бота с помощью Bot Platform](#как-создать-бота-с-помощью-bot-platform)

- [Шаг 1. Регистрация бота в мессенджере](#шаг-1.-регистрация-бота-в-мессенджере.)

  - [Telegram](#**telegram**)

  - [Viber](#**viber**)

  - [Facebook Messenger](#**facebook-messenger**)

- [Шаг 2. Создание компании в Sender](#шаг-2.-создание-компании-в-sender)

- [Шаг 3. Подключение бота к Bot Platform](#шаг-3.-подключение-бота-к-bot-platform)

- [Базовый функционал Bot Platform](#базовый-функционал-bot-platform.)

  - [Курс валют](#курс-валют)

  - [Смена языка общения](#смена-языка-общения)

  - [Стандартный опрос](#стандартный-опрос)

  - [Подключение оператора](#подключение-оператора)

  - [Опрос NPS](#опрос-nps)

- [Объекты папки Bot Platform 2.0](#объекты-папки-bot-platform-2.0)

  - [Процессы Viber/Telegram/Facebook Receiver](#процессы-viber/telegram/facebook-receiver)

  - [Процесс Main](#процесс-main)

  - [Описание параметров](#описание-параметров)

  - [Event](#event)

  - [Процесс Router](#процесс-router)

  - [Процесс Send Message](#процесс-send-message)

  - [Описание параметров](#описание-параметров)

  - [Папка Config](#папка-config)

  - [Tokens](#tokens)

  - [Command](#command)

  - [Attachments](#attachments)

  - [Пример](#пример)

- [Как работает Dynamic attachment?](#как-работает-dynamic-attachment?)

- [Добавление шаблона](#добавление-шаблона)

- [Массив элементов items](#массив-элементов-items)

- [Преобразование JSON](#преобразование-json)

- [Localization](#localization)

- [User Profile](#user-profile)

- [Расширение функций бота](#расширение-функций-бота)

- [Добавление новой команды](#добавление-новой-команды)

- [Работа с конфигурацией в Bot platform](#работа-с-конфигурацией-в-bot-platform)

  - [Commands](#commands)

  - [Localization](#localization)

  - [Attachments](#attachments)

- [Логика процесса](#логика-процесса-авторизации)

  
  
  

# Что такое Bot Platform

**Bot Platform** - это набор универсальных процессов в Corezoid для создания и управления ботами в наиболее популярных мессенджерах:

-   Facebook Messenger
-   Viber
-   Telegram.

Благодаря Bot Platform Вы можете создавать универсальные бизнес-процессы, которые доступны во всех мессенджерах, а не разрабатывать бизнес-логику под каждый из мессенджеров отдельно.

# Архитектура

  ![](../img/botplatform2_0/architecture.png)


# Как создать бота с помощью Bot Platform

## Шаг 1. Регистрация бота в мессенджере.

### **Telegram**

1.  Откройте в Telegram чат с ботом [BotFather](http://telegram.me/BotFather) и нажмите кнопку **Start**.
2.  Отправьте боту команду `/newbot` для создания нового робота.
3.  Укажите Username, которое будет отображаться в контактах и чатах, и адрес.
4.  Если адрес не занят, а имя введено правильно, BotFather пришлет в ответ сообщение с **токеном** — «ключом» для доступа к созданному боту и ссылкой на вашего нового бота.
5.  Сохраните токен для использования на следующем шаге.
    

### **Viber**

1.  Авторизоваться на [partners.viber.com](https://partners.viber.com/)
2.  Нажать **Create Bot Account**, заполнить информацию о боте.
3.  Получить **токен**.
4.  Сохранить токен для использования на следующем шаге.
    

### **Facebook Messenger**

1.  Войти в свой аккаунт [facebook](https://www.facebook.com/).
2.  [Создать](https://www.facebook.com/help/104002523024878?helpref=about_content) новую страницу, для которой будет работать бот.
3.  Перейти на специальную [страницу](http://developers.facebook.com/apps) для разработчиков. Если вы впервые находитесь на этой странице, то вас попросят зарегистрироваться в качестве разработчика.
4.  Открыть меню “Мои приложения” и нажать кнопку “Создать приложение”.
5.  Заполните форму:  
![](../img/botplatform2_0/create_a_new_app_id.png)
6.  После создания приложения, в меню слева добавить продукт Messenger нажатием кнопки «Настроить» ("Set up").
![](../img/botplatform2_0/page_access_token.png)
7.  Выберите страницу и сгенерируйте токен доступа к странице:
8.  Сохранить токен для использования на следующем шаге.
    

  



## Шаг 2. Создание компании в Sender

При создании **Bot Platform** необходимо выбрать существующую или создать новую компанию в [Sender](https://sender.mobi/ru/). Это необходимо для реализации стандартного функционала подключения оператора в чат в боте.  
  

[Sender](https://sender.mobi/ru/) - это мессенджер, который будет работать в качестве рабочего места операторов Вашей компании. Сообщения пользователей разных мессенджеров обрабатываются в едином интерфейсе.  
  

Для базовой настройки и тестирования перейдите в [административную панель Sender](https://admin.sender.mobi/), [создайте компанию и добавьте в нее операторов](https://doc.sender.mobi/adm_panel_operators.html).

  
После создания новой компании, она будет отображаться в Corezoid.  
  

Если нет учетной записи в Sender, необходимо установить приложение [Sender](https://sender.mobi/ru/) и зарегистрироваться с номером телефона или использовать для авторизации в [web-версии](http://chat.sender.mobi)  [виртуальный номер](https://cosmos.mobi).

## Шаг 3. Подключение бота к Bot Platform

Для создания **Bot Platform**:

-   В левом верхнем углу кликните на выпадающий список под надписью “Company” и выберите созданную на предыдущем шаге компанию Sender.
![](../img/botplatform2_0/create_bot_platform1.png)
-   нажмите кнопку **"Create"** и выберите **Bot Platform**
-   отметьте чекбоксы необходимых мессенджеров и введите ключи, полученные при создании ботов:
![](../img/botplatform2_0/create_bot_platform2.png)
-   Нажмите кнопку **"Next"**.  
      
   
Если все токены указаны корректно, начнется процесс подключения мессенджеров. В сообщении об успешном подключении нажмите кнопку для перехода в папку с процессами **Bot platform**.
  

Если был выбран Facebook Messenger, в диалоговом окне будет доступен для копирования webhook (URL для отправки сообщений из Facebook Messenger):
![](../img/botplatform2_0/webhook_for_fb.png)

**Скопируйте этот URL и завершите настройку приложения Facebook:**
1.  В настройках продукта Facebook в блоке [Webhook](https://en.wikipedia.org/wiki/Webhook) нажмите кнопку “Настройка Webhooks":
![](../img/botplatform2_0/setup_webhooks_fb.png)
2.  В поле “URL обратного вызова” вставьте скопированный URL.
3.  В поле “Подтвердить маркер” вставьте маркер доступа страницы, полученный ранее.
4.  Выберите [события](https://developers.facebook.com/docs/messenger-platform/webhook), которые необходимо получать в процесс. Рекомендуется отметить `messages, messaging_postbacks, messaging_optins`. Подтвердите действие.
5.  После успешного сохранения выберите страницу, на события которой будет подписано приложение и нажмите кнопку “Подписаться”:
![](../img/botplatform2_0/subscribe_fb_page.png)

  

Теперь все мессенджеры подключены к процессам и готовы к тестированию.


# Базовый функционал Bot Platform.

## Курс валют

Процесс **/exchangeRates (Dynamic Attachment)** в папке Sample Bots.
При нажатии в главном меню кнопки “Курс валют”, отображается карусель с текущим курсом Доллара США по отношению к другим валютам.

## Смена языка общения

Процесс **/changeLanguage** в папке Sample Bots.
Бот предлагает выбрать язык общения из 3 вариантов "en", "ru", "ua". Выбранное пользователем значение сохраняется в диаграмме состояний **User Profile** и применяется для **локализации** текстов и приложений в боте.

## Стандартный опрос

Процесс **/sampleSurvey** в папке Sample Bots/Sample Survey.
Бот предлагает оценить “Вам нравится этот бот?” с вариантами выбора "Да" и "Нет".
Результаты опроса копируются в диаграмму состояний **Results**, в которой узлы - это [метрики дашборда](https://doc.corezoid.com/ru/interface/dashboard.html#%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0-%D1%87%D0%B0%D1%80%D1%82%D0%B0)  **Results Dashboard**. Диаграмма состояний и дашборд размещены в одной папке с процессом опроса.

## Подключение оператора

Подключение оператора и маршрутизация сообщений из мессенджеров в операторский чат Sender осуществляется с помощью Логики **Sender action - Category "Widgets" - Robot "Send Message For Bot Platform".**

Для получения ответов от операторов используется процесс **Sender Receiver** (находится в папке Messengers/Sender/). На этапе создания **Bot platform** этот процесс автоматически подвязывается к событию Sender "Получение сообщений от бот платформы".

По умолчанию в компании есть только один оператор - владелец компании. Как добавить операторов подробно описано в [документации](https://doc.sender.mobi/adm_panel_operators.html).

## Опрос NPS

Процесс **/nps**, который находится в папке (Messengers/Sender/Chat/NPS), используется для оценки диалога, который запускается автоматически после завершения чата с оператором. Бот задает пользователю вопрос “Диалог был завершен. Уточните, пожалуйста, Ваш вопрос был решен?” и выбранная оценка передается в [аналитику](https://doc.sender.mobi/adm_panel_analytics.html#%D0%B4%D0%B8%D0%B0%D0%BB%D0%BE%D0%B3%D0%B8) Sender. Так же, как и в [стандартном опросе](https://docs.google.com/document/d/1TE6x4j1UTEo1sb7hyflKHL_Zz5OqAxVt1igSguvkBBw/edit#heading=h.y1axjqi0sxgw) предусмотрена диаграмма состояний и дашборд для статистики.

  

# Объекты папки Bot Platform 2.0

## Процессы Viber/Telegram/Facebook Receiver

С этих процессов начинается работа бота. [Webhook](https://en.wikipedia.org/wiki/Webhook) каждого бота подключается к одноименному процессу **Receiver** на этапе создания **Bot Platform** (Telegram и Viber - автоматически, Facebook Messenger - ручная настройка).

  

Логика процесса **Receiver**:
 -  принимает события (отправка сообщений, файлов, клики по кнопкам, переходы по ссылкам и др.) от пользователей ботов;
-   приводит полученные данные к единому формату:
	    `channel` - канал, из которого пришло сообщение. Доступные варианты:  
    telegram, facebook, viber.
	    `chat_id` - идентификатор чата, пользователя и т.п.
	    `event` - тип события
	    `message` - объект с деталями сообщени
-   передает данные в [процесс Main](https://docs.google.com/document/d/1TE6x4j1UTEo1sb7hyflKHL_Zz5OqAxVt1igSguvkBBw/edit#heading=h.mel4y4peaz87).
    

>**Обратите внимание!** Если Вы хотите к уже существующей **Bot Platform** подвязать другого бота, необходимо вручную подключить webhook к процессу **Receiver**. Для этого откройте информационную панель процесса (**View details**) и перейдите во вкладку **Webhook**.

  
Нажмите кнопку **Connect to messenger**, выберите мессенджер и укажите новый токен для подключения webhook к процессу. Также необходимо обязательно актуализировать токены в [диаграмме Tokens](https://docs.google.com/document/d/1TE6x4j1UTEo1sb7hyflKHL_Zz5OqAxVt1igSguvkBBw/edit#heading=h.bflip5i11roz). REF заявки должен называться “token”.
![](../img/botplatform2_0/connect_to_messenger.png)

## Процесс Main

Процесс **Main** получает на вход стандартизированный набор данных из мессенджеров и выполняет первичную бизнес-логику бота перед началом маршрутизации заявок по подпроцессам.

**Input JSON Example**

    {
	    "channel": "viber",
	    "chat_id": "12312321",
	    "event": "message",
	    "message": {
	    "type": "text",
	    "text": "Lorem ipsum..."
		}
    }

### Описание параметров
|**Parameter**|**Type**|**Required**|**Description**|
|---|---|---|---|
| channel  | string  | +  |  Название мессенджера, из которого обратился клиент |
|  chat_id |  string | +  | Уникальный идентификатор пользователя в мессенджере  |
|  event | string  |  + | Тип события. Возможный значения: `start, context, message, command`  |
| message  |  object | +  |  Объект сообщения |
| first_name  | string  | -  | Имя пользователя, которое передается из мессенджера.  |
|last_name  | string  |  - |  Фамилия пользователя, которое передается из мессенджера. |
| gender  | string  | -  | Пол, который пользователь указал в мессенджере при регистрации  |
|  user_picture |  string | -  |Ссылка на аватар пользователя|
|  country |  string | -  | Страна, в которой находится пользователь. Определяется автоматически мессенджером. |
| language  |  string |  - |  Язык устройства пользователя |
| timezone  |  string |  - | Временная зона  |
| context  |  string | -  | Данные, которые передаются с событием “context”  |

  

### Event
| Event   | Description                                                                                                                                                                                                                                |
|---------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| start   | Событие инициируется при первом подключении пользователя в бота. Для **Viber** событие передается при каждом открытии диалога.                                                                                                                 |
| context | Событие инициируется при наличии контекста во входящем сообщении от мессенджера. Контекст - дополнительные параметры, которые могут добавляться к ссылке для перехода в бота. Например: запуск какой-то команды, реферальная ссылка и т.п. |
| message | Инициируется при отправке сообщения пользователем                                                                                                                                                                                          |
| command | Инициируется при отправке пользователем текстовое сообщение типа “/…”                                                                                                                                                                      |


  

Пример конструкции для передачи данных через “context”.  
**Viber** - `viber://pa?chatURI={{public_account_name}}&context={{params}}`  
**Facebook Messenger** - `http://m.me/{{bot_name}}?ref={{params}}`  
**Telegram** - `https://telegram.me/{{bot_name}}?start={{params}}`

## Процесс Router

Процесс, который реализует главную логику обработки событий **Bot platform**. Здесь реализована обработка всех типов [event](https://docs.google.com/document/d/1TE6x4j1UTEo1sb7hyflKHL_Zz5OqAxVt1igSguvkBBw/edit#heading=h.dvaac7swglpy).
![](../img/botplatform2_0/router.png)
  

## Процесс Send Message

Процесс, который отвечает за отправку сообщений пользователям. Здесь происходит получение шаблонов текстов и приложений (кнопки, “карусель” и др.), локализация и динамическая подстановка значений в шаблоны.
![](../img/botplatform2_0/send_message.png)



### Описание параметров
| Parameter     | Type    | Required                                 | Description                                                                                                                                                                                                                                                                          |
|---------------|---------|------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| channel       | string  | +                                        | Название мессенджера, из которого обратился клиент                                                                                                                                                                                                                                   |
| chat_id       | string  | +                                        | Уникальный идентификатор пользователя в мессенджере                                                                                                                                                                                                                                  |
| text_id       | string  | +                                        | Название объекта с текстом, который будет отправлен пользователю. Тексты хранятся в State Diagram “[Localization](https://docs.google.com/document/d/1TE6x4j1UTEo1sb7hyflKHL_Zz5OqAxVt1igSguvkBBw/edit#heading=h.f7ftn7uxz4e3)”.                                                                                                                                                                    |
| attachment_id | string  | +                                        | Название объекта, который описывает приложение к текстовому сообщению (кнопки, карусели, клавиатуры). Приложения хранятся в State Diagram “[Commands](https://docs.google.com/document/d/1TE6x4j1UTEo1sb7hyflKHL_Zz5OqAxVt1igSguvkBBw/edit#heading=h.g4e3z8r7ftjq)”.                                                                                                                                |
| items         | array   | + (если используется Dynamic attachment) | Массив объектов, который используется для динамической подстановки параметров в переменные для отображения пользователю в виде карусели или клавиатуры.                                                                                                                              |
| currentPage   | integer | + (если используется Dynamic attachment) | Каждый мессенджер имеет ограничение по кол-ву отображаемых элементов в клавиатуре и карусели.Если кол-во элементов в массиве “items” больше макс. допустимого кол-ва отображаемых элементов, массив разбивается на страницы (пагинация). По умолчанию, стартовый номер страницы = 1. |

  

**Input JSON Example**

    {
    	"channel": "viber",
    	"chat_id": "12345...",
    	"text_id": "main_text",
    	"attachment_id": "main_keyboard",
    }

  

**Input JSON Example (Dynamic attachment)**

    {
    	"channel": "viber",
    	"chat_id": "12345...",
    	"text_id": "exchange_rates",
    	"attachment_id": "carousel_pattern",
    	"items": [
    	{
    	"name": "AED",
    	"value": 4.283634
    	},
    	{
    	"name": "AFN",
    	"value": 85.711652
    	},
    	{
    	"name": "ALL",
    	"value": 126.118624
    	},  
    	...
    	"currentPage": 1
    }

## Папка Config

В Bot Platform 2.0 предусмотрены диаграммы состояний отвечающие за хранение данных:

-   **Tokens** - токены ботов для мессенджеров (Viber, Telegram, FB Messenger).
-   **Commands** - соответствие (связка) названий команд и ID процессов.
-   **Localization** - тексты локализации контента.
-   **Attachments** - шаблоны приложений к сообщениям (кнопки, клавиатуры, “карусели”, списки), описанные в формате JSON.
-   **User Profile** - данные пользователей бота.  
      
    
Процессы **Bot Platform** взаимодействуют с диаграммами состояния с помощью [динамической конструкции](https://doc.corezoid.com/ru/interface/functions/getParamFromApp.html) для получения данных.

### Tokens
Эта диаграмма состояний отвечает за хранение токенов от ботов. Токены нужны для вызова API мессенджеров для отправки сообщений пользователям.

  

**JSON Example**  
  
**REF: token**

    {
    	"telegram": "...",
    	"viber": "...",
    	"facebook": "...",
    }

  

### Command

Для того, чтобы клик на кнопку в боте запускал процесс в Corezoid, необходимо создать связь между названием команды, которая инициируется при нажатии кнопки, и ID процесса, который должен быть запущен в Corezoid.

  

**Router** по названию команды [вычитывает](https://doc.corezoid.com/ru/interface/functions/getParamFromApp.html) значение параметра process_id заявки из диаграммы **Commands** и запускает процесс.

  

>**Обратите внимание!** REF заявки должен называться так же, как и ваша команда, с учетом введенного регистра. Например: /changeLanguage.

  
  

**JSON Example**

  
**REF: /changeLanguage**

    {
    	"process_id": "12345"
    }

  

### Attachments

Мессенджеры поддерживают отправку не только текстовых сообщений, но и различных приложений к сообщениям: кнопки, клавиатуры, "карусели", списки и др.

  

Все объекты, описывающие приложения к текстовым сообщениям, содержатся в диаграмме состояний **Attachments**. При добавлении приложения в диаграмму, мы рекомендуем указывать название [референса заявки](https://doc.corezoid.com/ru/interface/tasks/) в соответствии с названием целевого действия, для которого будет использоваться данное приложение. Например, “mainMenu” - для отображения главного меню, “exit” - для кнопки выхода из текущего бизнес-процесса и т.д.  
  

Это значение в дальнейшем указывается в параметре `attachment_id` при отправке сообщения пользователю.


Процесс **Send message** с помощью [динамической конструкции](https://doc.corezoid.com/ru/interface/functions/getParamFromApp.html):

    {{conv[{{attachment_proc_id}}].ref[{{attachment_id}}]}}
    
получает объект с описанием приложений для всех мессенджеров. Далее в параметр `attachment` сохраняется то приложение, которое соответствует `channel` и к нему применяются:
-   **локализация**: все значения `{{t'<key>}}` в параметрах приложения заменяются на тексты из [Localization](https://docs.google.com/document/d/1TE6x4j1UTEo1sb7hyflKHL_Zz5OqAxVt1igSguvkBBw/edit#heading=h.f7ftn7uxz4e3);
-   **динамическая подстановка значений**: замена переменных `{{param}}`, которые используются в описании приложения на значения параметров, которые поступают в процесс **Sender Message** вместе с заявкой.
    
Сформированное сообщение бот отправляет пользователю.

  
  

#### Пример

По умолчанию диаграмма состояний **Attachments** уже  содержит примеры готовых приложений.
  

**mainKeyboard - кнопки главного меню**

Facebook Messenger:  
![](../img/botplatform2_0/main_keyboard_fb.png)  
  

Viber:
![](../img/botplatform2_0/main_keyboard_viber.png)  

  

Telegram:
![](../img/botplatform2_0/main_keyboard_telegram.png)  


Детальнее с типами сообщений можно ознакомиться непосредственно в документации API мессенджера:

-   [Viber](https://viber.github.io/docs/api/rest-bot-api/#message-types)
-   [Facebook Messenger](https://developers.facebook.com/docs/messenger-platform/reference/send-api/)
-   [Telegram](https://core.telegram.org/bots/api#message)
    

  

**JSON Example**

**REF: exit**

    {
	    "telegram": {
		    "type": "inline_keyboard",
		    "buttons": [
			    [
				    {
				    "text": "🚪 {{t'exit}}",
				    "callback_data": "/exit"
					 }
				    ]
				   ]
			    },
			    "viber": {
				    "type": "keyboard",
				    "buttons": [
					{
					    "Columns": 6,
					    "Rows": 1,
						"BgColor": "#F3F3F3",
					    "Text": "🚪 {{t'exit}}",
					    "ActionType": "reply",
					    "ActionBody": "/exit",
					    "TextVAlign": "middle",
					    "TextHAlign": "center",
					    "TextSize": "regular",
					    "Silent": true
							    }
						    ]
					    },
		    "facebook": {
			    "type": "quick_replies",
			    "buttons": [
			    {
				    "content_type": "text",
				    "title": "🚪 {{t'exit}}",
				    "payload": "/exit"
			    }
		    ]
	    }
    }

  
  
  
#### Как работает Dynamic attachment?

  

При разработке бота часто возникает необходимость отображать данные однородной структуры. Это может быть каталог продукции, корзина с выбранными товарами, перечень действующих акций и т.д.

  

Процесс **Send message** поддерживает формирование приложений по шаблону для переменного количества элементов.

  

##### Добавление шаблона

Рассмотрим на примере существующего шаблона в **Attachment** для отображения курса валют:

  

**JSON Example (Dynamic attachment)**

**REF: carousel_pattern**

    {
    	"attachment": {
    		"facebook": {
    			"type": "carousel",
    			"items": [
    				{
    					"title": "{{value}} {{name}}",
    					"subtitle": "1 USD"
    				}
    			]
    		},
    		"viber": {
    			"type": "carousel",
    			"carouselRows": "1",
    			"carouselColumns": "6",
    			"items": [
    			{
    				"Columns": 6,
    				"Rows": 1,
    				"ActionType": "reply",
    				"ActionBody": "none",
    				"Text": "1 USD = {{value}} {{name}}",
    				"TextSize": "small",
    				"TextVAlign": "middle",
    				"TextHAlign": "middle",
    				"Silent": true,
    				"BgColor": "#FFFFFF"
    			}
    		]
    	}
    }
    }

  

>**Обратите внимание!** Для Telegram шаблон не описан, т.к. Telegram не поддерживает подобный тип сообщений.

  

##### Массив элементов items

  

Для формирования “карусели” необходимо сформировать массив элементов, из которого значения будут подставлены в шаблон:

    "items": [
    		{
    			"title": "4.183966 AED",
    			"subtitle": "1 USD"
    		},
    			{
    			"title": "85.890287 AFN",
    			"subtitle": "1 USD"
    			}
    ]

 
##### Преобразование JSON

При вызове процесса **Send message** необходимо обязательно передать параметры:

-   **attachment_id** = "carousel_pattern"
-   **items** = "items"
-   **currentPage** = 1
-   **disableExitButton** = false|true (флаг отображение кнопки “Выход”)

Все остальные действия с объектом выполняет узел с логикой **Code** "createDynamicAttachment".
![](../img/botplatform2_0/disableExitButton.png)

  

Процесс **Send Message** автоматически разбивает весь массив элементов на страницы и добавляет кнопки навигации (пагинация). При разбивке на страницы учитываются ограничения мессенджера согласно документации. При значении параметра **disableExitButton=false** добавляется кнопка “Выход”.


**Преобразованный JSON :**  

    "message":{
    	"quick_replies":[
    				{
    		"content_type":"text",
    		"title":"🚪 Exit",
    		"payload":"/exit"
    				}
    		],
    		"attachment":{
    		"type":"template",
    		"payload":{
    		"template_type":"generic",
    		"elements":[
    			{
    			"title":"4.183966 AED",
    			"subtitle":"1 USD"
    			},
    		{
    			"title":"85.890287 AFN",
    			"subtitle":"1 USD"
    		}
    	]
    }
    }
    }

  
  

**Пример отображения**
Facebook Messenger:  
![](../img/botplatform2_0/rates_usd_fb.png)
  
  
Viber:  
![](../img/botplatform2_0/rates_viber.png)  
  

### Localization

Диаграмма состояний **Localization** хранит все тексты сообщений и тексты, используемые в приложениях (кнопках, каруселях и др.), в одной заявке:

**REF: localization**

    {
    	"/exit": {
    		"en": "Exit",
    		"ru": "Выход",
    		"ua": "Вихід"
    	},
    		"mainMenu": {
    		"en": "Main Menu",
    		"ru": "Главное меню",
    		"ua": "Головне меню"
    	},
    		"no": {
    		"en": "No",
    		"ru": "Нет",
    		"ua": "Ні"
    	},
    		"yes": {
    		"en": "Yes",
    		"ru": "Да",
    		"ua": "Так"
    	},
    ...
    }

  

Такой подход позволяет:

1.  централизовать управление всеми текстами бота;
2.  отправлять сообщения, указав лишь **key** необходимого текста в объекте **localization**
3.  реализовать локализацию интерфейса бота. По умолчанию тексты указаны на языках **en**, **ru**, **ua**, но добавить можно любой язык мира.


Для отправки текстового сообщения необходимо передать в значение параметра `text_id` название ключа (key) из заявки **localization**.
![](../img/botplatform2_0/send_text_message.png)

  

**Пример**. Для отправки главного меню в боте необходимо в процесс **Send message** передать параметры:

    {
    "attachment_id":"mainKeyboard",
    "channel":"viber",
    "chat_id":"...",
    "text_id":"mainMenu"
    }

Для использования локализации в приложениях (attachments) параметры (текст кнопок, заголовки и др.) задаются в формате `{{t'<key>}}`, где `key` - ключ необходимого текста в объекте **localization**.  
  

**Пример**. Для локализации кнопки “Выход”:

    {  
    "content_type": "text",  
    "title": "🚪 {{t'/exit}}",  
    "payload": "/exit"  
    }

  

Процесс **Send message** отправляет сообщение на том языке, который хранится в диаграмме состояний **User Profile** для пользователя. По умолчанию - язык **en**, эта настройка изменяется на уровне узла  Set Parameter в процессе **Send message**.

### User Profile

Диаграмма состояний, в которой хранятся данные пользователей бота. Создание пользователя происходит при первом обращении к боту и при дальнейшей активности актуализируются.

Создание/редактирование заявки с данными пользователя происходит из процесса **Main** с указанием референса строго заданного формата: 
**`{{channel}}_{{chat_id}}`**, где  
  

`channel` - название мессенджера, из которого обратился клиент;
`chat_id` - уникальный идентификатор пользователя в мессенджере.  

**Пример**: viber_2yOPxC85DSpJCJHpYzjqTw=


Т.к. параметры `channel` и `chat_id` используются и являются обязательными во всех процессах **Bot platform**, это дает возможность получать и редактировать данные пользователя на любом этапе.

  

# Расширение функций бота

## Добавление новой команды

Очень часто для разграничения доступа к данным/функционалу бота необходимо получить личные данные пользователя и подтвердить личность (провести авторизацию пользователя). Чаще всего для этого используется номер телефона пользователя и одноразовый пароль, который отправляется в SMS.

  

Дополним стандартный функционал бота новой командой: авторизация по номеру телефона.

Для этого перейдите в папку **Sample Bots** и создайте новый процесс с названием **/auth**. Новый процесс пока что содержит 2 стандартных узла, позднее мы наполним его логикой.

## Работа с конфигурацией в Bot Platform

Для добавления логики авторизации, нам необходимо произвести ряд изменений в стандартных процессах Bot Platform. Общий алгоритм работы процесса авторизации представлен на схеме:
![](../img/botplatform2_0/auth.png)


### Commands

Каждый бот состоит из совокупности функций. В парадигме Bot Platform 2.0, каждая функция - это отдельный процесс, который вызывается с помощью команды. Формат команды имеет конструкцию: **“/” + название команды**. Вызов необходимого процесса происходит с помощью стандартного процесса **Router**, который обращается в диаграмму состояний **Commands** для получения связки данных “**команда**: **process_id**”, где **process_id** - ID процесса, который необходимо вызвать.


Согласно этой конструкции, команда для запуска функции (процесса) авторизации будет называться **/auth**.  
  
Для того, чтобы команда **/auth** запустила процесс авторизации, нам необходимо добавить в диаграмму состояний **Commands** заявку, которая будет хранить связку “название команды: ID процесса”.  
  

**Для этого нужно добавить конфигурационную заявку:**

1.  Откройте диаграмму состояний **Commands** (в папке Config).
2.  Переведите процесс в режим **View**.
3.  Нажмите “+ New task” и заполните данные заявки:
![](../img/botplatform2_0/new_task.png)


где:
-   **REF** - название процесса/команды (в данном случае /auth)
-   **process_id** - ID процесса /auth  

4.  Нажмите Add task.
    

  

Теперь если отправить боту команду **“/auth”**, процесс **Router** будет получать идентификатор процесса из диаграммы состояний **Commands** и запускать процесс **/auth**.

  

### Localization

Общение с ботом происходит в формате “вопрос-ответ”. Для того, чтобы получить номер телефона пользователя, бот должен запросить номер у пользователя, а пользователь отправить свой номер телефона.  
  

Отредактируйте заявку с текстами в диаграмме состояний **Localization**, добавив в нее текст сообщения и подпись для кнопки запроса телефона:

    {
    		"askPhone": {
    		"ru": "Пожалуйста, нажмите кнопку для отправки номера телефона",
    		"ua": "Будь ласка, натисніть кнопку для відправки номера телефону",
    		"en": "Please press the button to share your phone number"
    	},
    		"sharePhone": {
    		"ru": "Отправить мой номер телефона",
    		"ua": "Надіслати мій номер телефону",
    		"en": "Share my phone number"
    	}
    }

### Attachments

Мессенджеры предоставляют возможность получить номер телефона, если пользователь нажмет на специальную кнопку:
| Мессенджер         | Параметр                           | Пример кнопки                                                                                                                    |
|--------------------|------------------------------------|----------------------------------------------------------------------------------------------------------------------------------|
| Viber              | ["ActionType":"share-phone"](https://developers.viber.com/docs/tools/keyboards/#buttons-parameters)         | `{"Columns": 6,"Rows": 1,"BgColor": "#F3F3F3","Text": "{{t'sharePhone}}","ActionType": "share-phone","ActionBody": "phone"}` |
| Telegram           | ["request_contact":true](https://core.telegram.org/bots/api#keyboardbutton)             | `{"request_contact": true,"text": "{{t'sharePhone}}"}`                                                                           |
| Facebook Messenger | ["content_type":"user_phone_number"](https://developers.facebook.com/docs/messenger-platform/send-messages/quick-replies/#phone) | `{"content_type": "user_phone_number"}`                                                                                           |

  

Для этого вам необходимо добавить в диаграмму состояний **Attachments** шаблон приложения, в котором будет 2 кнопки:

-   для отправки номера телефона;
-   для выхода в главное меню.
    

Добавьте новую заявку со следующим содержанием:

  
**REF: sharePhone**

    {
    	"facebook": {
    		"type": "quick_replies",
    		"buttons": [
    	{
    		"content_type": "user_phone_number"
    	},
    	{
    		"content_type": "text",
    		"title": "{{t'/exit}}",
    		"payload": "/exit"
    	}
    ]
    },
    		"telegram": {
    		"type": "keyboard",
    		"buttons": [
    	[
    		{
    			"request_contact": true,
    		"text": "{{t'sharePhone}}"
    		}
    	],
    		[
    			{
    				"text": "{{t'/exit}}"
    			}
    		]
    	]
    },
    	"viber": {
    		"type": "keyboard",
    		"buttons": [
    				{
    					"Columns": 6,
    					"Rows": 1,
    					"BgColor": "#F3F3F3",
    					"Text": "{{t'sharePhone}}",
    					"ActionType": "share-phone",
    					"ActionBody": "phone"
    				},
    		{
    			"Columns": 6,
    			"Rows": 1,
    			"BgColor": "#F3F3F3"
    			"Text": "{{t'/exit}}",
    			"ActionType": "reply",
    			"ActionBody": "/exit"
    		}
    	]
    }
    }

  

> **Обратите внимание!** Ранее в диаграмме Localization был добавлен текст кнопки для отправки номера телефона в ключе локализации "`sharePhone`". Этот ключ мы будем использовать для подстановки локализированных текстов в наши кнопки:

`"text": "{{t'sharePhone}}"` и `"Text": "{{t'sharePhone}}"`.


Когда пользователь нажмет эту кнопку, в процесс **Receiver** соответствующего мессенджера поступит объект с номером телефона пользователя, который в дальнейшем можно использовать для авторизации пользователя или других бизнес-процессов.

## Логика процесса авторизации

Когда конфигурационные настройки завершены, дополним процесс **/auth** логикой авторизации. Ниже представлена пошаговая схема с описанием процесса авторизации:
![](../img/botplatform2_0/auth_logic.png)

  

**1. Отправка сообщения пользователю**
Отправка сообщения от бота пользователю происходит путем копирования заявки в процесс **Send Message**. В логике Copy task необходимо указать следующие параметры:

-   **channel**: `{{channel}}` из заявки для конкретного пользователя
-   **chat_id**: `{{chat_id}}` из заявки для конкретного пользователя
-   **text_id**: `"askPhone"` (сообщение с просьбой нажать кнопку)
-   **attachment_id**: `"sharePhone"` (заготовленный шаблон кнопок)
    
**2. Ожидание ответа от пользователя**
После отправки сообщения бот ожидает действия пользователя. Для этого в процессе используется логика **Waiting for Callback**. В случае любого ответного действия пользователя заявка будет изменена и перейдет в узел 3.

**3. Проверка стандартного выхода из команды**
Для корректной работы бота и удобной навигации рекомендуется использовать кнопку с командой **/exit** для возможности отменить выполнение текущего процесса и выйти в главное меню. Если использовать такой подход, то обязательно необходимо добавить проверку условия выхода (узел с логикой **Condition**).

  

**4. Проверка переданного номера телефона**
Если пользователь не прервал выполнение процесса нажатием кнопки **Exit**, то наш процесс выполняется дальше и проверяет введенное пользователем сообщение при помощи логики **Condition**. В нашем случае, если пользователь ввел недопустимое значение (некорректный номер телефона и т.д.), то мы попросим ввести номер телефона или нажать кнопку отправки номера телефона еще раз. 
>Логику можно дополнить выводом сообщения об ошибке или подсказкой.

  

**5.1. Сохранение номера телефона из сообщения с контактом (Viber, Telegram)**
Если предыдущее условие выполнено успешно, и мы получили объект `message` с контактом, то мы сохраняем номер телефона в параметр `phone`.

  

**5.2. Сохранение номера телефона из текстового сообщения (FB Messenger)**
Если предыдущее условие выполнено успешно, и мы получили объект `message` с текстом, который соответствует регулярному выражению для номера телефона, то мы сохраняем это значение в параметр `phone`.

  

**6. Сохранение номера телефона в профиль пользователя**
Полученное ранее значение параметра `phone` сохраняется в диаграмму состояний **User Profile** в профиль пользователя и его можно будет переиспользовать в других процессах.

  

**7. Завершение процесса**
Для завершения работы процесса и возврата в главное меню используется команда **/end**. Необходимо с помощью логики **Copy task** передать в **Router**  `"command":"/end"`.

