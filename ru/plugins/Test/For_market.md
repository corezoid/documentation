После выполнения действий в разделе “Подготовка” Вы получите робота Viber, который выдает карты METRO* и показывает список существующих карт.
Выдача осуществляется с формированием и отправкой пользователю штрих-кода, содержащем информацию о карте.

*номера карт METRO фейковые, максимум 3 карты одному пользователю

![](https://git.corezoid.com/conveyors/doc_corezoid/raw/1bc134d063442eb9f1545052ebce82b65ce3c885/ru/plugins/Test/BpyVqUW0TP.gif)


## Подготовка
 
**1)** Подключите **Receiver & Route message**к Viber Webhook:

* перейдите на вкладку `Webhook`
* нажмите на `Connect to messenger`
* выберите `Viber`
* нажмите на кнопку `"Set Webhook"` и укажите токен Вашего Public Account

![](https://doc.corezoid.com/ru/plugins/img/viber/viber_set_wh.gif)


**2)** В случае необходимости, установите приветственное сообщение для Вашего Public Account:

* после выбора `Viber` нажмите на кнопку `"Set Welcome message"`
* выберите тип приветственного сообщения - текст или картинка с текстом
* заполните нужные поля

![](https://doc.corezoid.com/ru/plugins/img/viber/viber_set_wh.gif)

Приветственное сообщение отправляется в ответ на полученный webhook, содержащий `"event": "conversation_started"`.

Это событие сигнализирует о том, что пользователь перешел в чат с Вашим Public Account первый раз (т.е. история отсутствует) или когда чат открыт через deep link.

`"conversation_started"` не считается подпиской и не позволяет Public Account отправлять сообщения пользователям.

Но разрешает отправить одно приветственное.

В демо версии начало диалога с ботом осуществляется через отправку команды “Start” - можно использовать этот вариант.




**3)** В процессах используется API [imgur](https://imgur.com/), для формирования прямой ссылки на изображение штрих-кода, закодированного в base64. 

Для вызова  API imgur нужна авторизация OAuth 2.0, т.е. каждый запрос к API должен содержать в `Header`:
```
Authorization : Bearer {{ACCESS_TOKEN}}
```

**Чтобы получить access_token**:

* Создайте `Client ID` и `Client Secret` своего приложения на https://imgur.com
* В URL подставьте параметры и вызовите его в браузере
https://api.imgur.com/oauth2/authorize?client_id=YOUR_CLIENT_ID&response_type=code&state=APPLICATION
* Cкопируйте код, который появится в конце вновь сформированного URL
* Перейдите в режим View диаграммы `State token`, что в папке `IMGur` и нажмите кнопку `New task`.
В окне `Add new` значением поля `Reference` задайте `token`, заполните указанные ниже поля и нажмите `Add task`.
   *   client_id - Client ID Вашего приложения imgur
   *   client_secret - Client Secret Вашего приложения imgur
   *   code - Вы получили его из ссылки в браузере

В случае успшеного содания access_token, Ваша заявка будет находиться в узле Active token. Нажав на него Вы увидете содержимое заявки, одним из параметров которой является access_token.

Вы можете использовать полученный access_token для работы с любым API imgur добавляя его в Header как:
```
Authorization : Bearer {{conv[ID_DIAGRAM].ref[REFERENCE].access_token}}
```
где:
*   `ID_DIAGRAM` - ID диаграммы `State token`. Этот ID можно получить:
    1.  Выбрать процесс в режиме браузера диаграмм
    2.  Выбрав узел `Start` внутри диаграммы
*   `REFERENCE` - этим значением является `token`.

**4)** Добавьте id  процессов `Command "history"` и `Command "get_card"` (оба в папке Commands) в процесс `MAIN logic` в узлы `“Get card proc”` и `“History proc”` соответственно.

![](https://s.sender.mobi/u/image/2017/10/6/ZiKXS3oc0/276458_-_MAIN_logic.png)




Процессы для реализации данного робота являются демонстрационными.

Для рабочего робота необходима, как минимум верификация указанного пользователем номера телефона (например, через OTP) и реальные номера карт.

Вы можете развивать функционал робота согласно Вашим потребностям. Например, добавить кнопки и соответствующую логику для вывода последних n транзакций по карте и т.д.
